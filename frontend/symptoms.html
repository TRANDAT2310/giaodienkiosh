<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chọn Triệu Chứng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .autocomplete-suggestions {
            border: 1px solid #ccc;
            max-height: 220px;
            overflow-y: auto;
            position: absolute;
            background: #fff;
            z-index: 10;
            width: 100%;
        }

        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }

        .autocomplete-suggestion:hover {
            background: #f0f0f0;
        }

        .selected-symptom {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: #d1ecf1;
            border-radius: 20px;
        }
    </style>
</head>

<body class="p-4">
    <h2 class="mb-4 text-center">Chọn triệu chứng bạn đang gặp phải</h2>

    <form id="symptom-form">
        <div class="mb-3 position-relative">
            <label class="form-label">Nhập triệu chứng:</label>
            <input type="text" class="form-control" id="symptom-input" autocomplete="off"
                placeholder="Ví dụ: Tôi cảm thấy sốt, Tôi bị ho khan...">
            <div id="suggestions" class="autocomplete-suggestions"></div>
        </div>

        <div class="mb-3">
            <label>Triệu chứng đã chọn:</label>
            <div id="selected-symptoms"></div>
        </div>

        <button type="submit" class="btn btn-success">Tiếp tục</button>
    </form>

    <script>
        const symptomInput = document.getElementById("symptom-input");
        const suggestionsBox = document.getElementById("suggestions");
        const selectedSymptomsBox = document.getElementById("selected-symptoms");

        let allSymptoms = [];   // chỉ lưu danh sách tên triệu chứng để gợi ý
        let rawData = [];       // giữ nguyên object từ JSON để lấy mức độ
        let selectedSymptoms = []; // [{trieu_chung: "...", muc_do: "..."}]

        // ĐƯỜNG DẪN ĐÚNG (chọn 1 trong 2, ưu tiên cái đầu):
        const JSON_URL = "../backend/data/benh_ly.json";     // relative từ /frontend/
        // const JSON_URL = "/backend/data/benh_ly.json";     // tuyệt đối từ root server

        // 1) Load JSON
        (async () => {
            try {
                const res = await fetch(JSON_URL, { cache: "no-cache" });
                if (!res.ok) throw new Error("HTTP " + res.status);
                rawData = await res.json();
                allSymptoms = rawData.map(item => item["triệu_chứng"]);
                console.log("Dữ liệu load từ JSON:", rawData);
            } catch (err) {
                console.error("Lỗi khi load JSON:", err);
                alert("Không tải được dữ liệu triệu chứng. Kiểm tra lại đường dẫn hoặc Live Server.");
            }
        })();

        // 2) Gợi ý theo từ khóa
        symptomInput.addEventListener("input", () => {
            const inputVal = symptomInput.value.toLowerCase().trim();
            suggestionsBox.innerHTML = "";
            if (!inputVal) return;

            const filtered = allSymptoms.filter(s =>
                s.toLowerCase().includes(inputVal) &&
                !selectedSymptoms.some(sel => sel.trieu_chung === s)
            );

            filtered.forEach(symptom => {
                const div = document.createElement("div");
                div.className = "autocomplete-suggestion";
                div.textContent = symptom;
                div.addEventListener("click", () => {
                    addSymptom(symptom);
                    symptomInput.value = "";
                    suggestionsBox.innerHTML = "";
                });
                suggestionsBox.appendChild(div);
            });
        });

        // 3) Thêm triệu chứng đã chọn
        function addSymptom(symptom) {
            // Nếu symptom là object => chỉ lấy tên
            const symptomName = typeof symptom === "object" ? symptom["triệu_chứng"] : symptom;

            if (selectedSymptoms.includes(symptomName)) return;
            selectedSymptoms.push(symptomName);

            const span = document.createElement("span");
            span.className = "selected-symptom";
            span.textContent = symptomName;
            selectedSymptomsBox.appendChild(span);
        }


        // 4) Submit -> recommendation.html
        document.getElementById("symptom-form").addEventListener("submit", (e) => {
            e.preventDefault();
            if (selectedSymptoms.length === 0) {
                alert("Vui lòng chọn ít nhất 1 triệu chứng.");
                return;
            }
            localStorage.setItem("selectedSymptoms", JSON.stringify(selectedSymptoms));
            window.location.href = "recommendation.html";
        });

        // Ẩn gợi ý khi click ra ngoài
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".position-relative")) {
                suggestionsBox.innerHTML = "";
            }
        });
    </script>

</body>

</html>